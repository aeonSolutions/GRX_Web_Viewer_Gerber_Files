// import { parse } from '@tracespace/parser'
// TODO: Await v5 release of @tracespace/parser
import { parse, GerberTree } from '@hpcreery/tracespace-parser'
// import { ImageTree, plot } from '@tracespace/plotter'
// TODO: Await v5 release of @tracespace/plotter
import { ImageTree, plot } from '@hpcreery/tracespace-plotter'

import { GraphPaper, GraphStyle } from 'pixi-graphpaper'
import { Viewport } from 'pixi-viewport'
import * as PIXI from 'pixi.js'
import { DisplayObject } from 'pixi.js'
import { useRef, useEffect, useState, useLayoutEffect, useMemo } from 'react'
import { CustomPixiApplication } from '../renderer'
import useResizeObserver from '@react-hook/resize-observer'
import useSize from '../hooks/useSize'
// import test from '@tracespace/fixtures/gerbers/circle-with-hole.gbr'
import pads from './gerbervar'
let gerber = `%FSLAX34Y34*%
%MOIN*%
%ADD10C,0.5X0.25*%
D10*
X0Y0D03*
M02*
`

// gerber = `%FSLAX33Y33*%
// %MOIN*%
// %ADD10R,1.0X0.5*%
// D10*
// G75*
// G36*
// X200Y1000D02*
// G01X1200D01*
// G01Y200D01*
// G01X200D01*
// G01Y600D01*
// G01X500D01*
// G03X500Y600I300J0D01*
// G01X200D01*
// G01Y1000D01*
// G37*
// M02*
// `

// gerber = `%FSLAX34Y34*%
// %MOIN*%
// %ADD10C,0.5X0.25X0.15*%
// D10*
// X0Y0D03*
// M02*
// `

// // Full circles => works
// gerber = `%FSLAX34Y34*%
// %MOIN*%
// %ADD10C,0.15*%
// D10*
// G75*
// G03*
// X0Y0I-5000D01*
// X3000Y0D02*
// G02*
// X3000Y0I5000D01*
// M02*
// `

// Two Arcs drawn with circles => works
// gerber = `%FSLAX34Y34*%
// %MOIN*%
// %ADD10C,0.15*%
// D10*
// G75*
// X-2500Y2500D02*
// G03*
// X-7500Y2500I-2500J-2500D01*
// X2500Y2500D02*
// G02*
// X7500Y2500I2500J-2500D01*
// M02*
// `

// lines drawn with squares
// gerber = `%FSLAX34Y34*%
// %MOIN*%
// %ADD10R,0.2X0.1*%
// D10*
// G01*
// X10000Y4000D01*
// G01*
// X3000Y8000D01*
// G01*
// X1000Y6000D01*
// G01*
// X4000Y4000D01*
// M02*
// `

// // sqare with square hole => Works
// gerber = `%FSLAX33Y33*%
// %MOIN*%
// %ADD10R,1.0X0.5*%
// D10*
// G36*
// X12200Y25700D02*
// G01Y27200D01*
// G01X13100D01*
// G01Y25700D01*
// G01X12500D01*
// G01Y26000D01*
// G01X12900D01*
// G01Y26400D01*
// G01X12500D01*
// G01Y26700D01*
// G01X12900D01*
// G01Y27000D01*
// G01X12500D01*
// G01Y26700D01*
// G01Y26400D01*
// G01Y26000D01*
// G01Y25700D01*
// G01X12200D01*
// G37*
// M02*
// `

// masks
gerber = `%FSLAX34Y34*%
%MOIN*%
%AMTEST*
0 dark 1"x0.5" center rect at 0,0*
21,1,1,0.5,0,0,0*
0 clear 0.4" circle at 0,0*
1,0,0.4,0,0*
0 dark 0.1"x0.75" center rect at 0,0*
21,1,0.1,0.75,0,0,0*
0 dark 0.75"x0.1" center rect at 0,0.35*
21,1,0.75,0.1,0,0.35,0*
0 clear 0.1" circle at 0,0.35"*
1,0,0.1,0,0.35*
0 clear 0.1" circle at -0.35,0"*
1,0,0.1,-0.35,0*
0 clear 0.1" circle at 0.35,0"*
1,0,0.1,0.35,0*%
%ADD10TEST*%
D10*
X0Y0D03*
M02*
`

// TODO: inverse mask // very weird
// gerber = `%FSLAX34Y34*%
// %MOIN*%
// %AMTEST*
// 0 dark 1"x0.5" center rect at 0,0*
// 21,1,1,0.5,0,0,0*
// 0 clear 0.4" circle at 0,0*
// 1,0,0.4,0,0*
// 0 dark 0.1"x0.75" center rect at 0,0*
// 21,1,0.1,0.75,0,0,0*
// 0 dark 0.75"x0.1" center rect at 0,0.35*
// 21,1,0.75,0.1,0,0.35,0*
// 0 clear 0.1" circle at 0,0.35"*
// 1,0,0.1,0,0.35*
// 0 clear 0.1" circle at -0.35,0"*
// 1,0,0.1,-0.35,0*
// 0 clear 0.1" circle at 0.35,0"*
// 1,0,0.1,0.35,0*%
// %LPD*%
// D11*
// X0Y0D03*
// %LPC*%
// D10*
// X0Y0D03*
// M02*
// `

// let geber = `
// %FSLAX34Y34*%
// %MOIN*%
// %AMTEST*
// 0 dark 1"x0.5" center rect at 0,0*
// 21,1,1,0.5,0,0,0*
// 0 clear 0.4" circle at 0,0*
// 1,0,0.4,0,0*
// 0 dark 0.1"x0.75" center rect at 0,0*
// 21,1,0.1,0.75,0,0,0*
// 0 dark 0.75"x0.1" center rect at 0,0.35*
// 21,1,0.75,0.1,0,0.35,0*
// 0 clear 0.1" circle at 0,0.35"*
// 1,0,0.1,0,0.35*
// 0 clear 0.1" circle at -0.35,0"*
// 1,0,0.1,-0.35,0*
// 0 clear 0.1" circle at 0.35,0"*
// 1,0,0.1,0.35,0*%
// %ADD10TEST*%
// D10*
// X0Y0D03*
// M02*
// `

// // inverse mask // very weird
// gerber = `
// %FSLAX34Y34*%
// %MOIN*%
// %AMMOIRE1*
// 6,0,0,0.5,0.04,0.025,2,0.01,0.55,0*%
// %ADD10MOIRE1*%
// %ADD11R,1.1X1.1*%
// %LPD*%
// D11*
// X0Y0D03*
// %LPC*%
// D10*
// X0Y0D03*
// M02*
// `

// moire
// gerber = `%FSLAX34Y34*%
// %MOIN*%
// %AMMOIRE1*
// 6,0,0,0.5,0.04,0.03,2,0.01,0.55,0*%
// %AMMOIRE2*
// 6,0,0,0.5,0.04,0.03,4,0.01,0.55,0*%
// %ADD10MOIRE1*%
// D10*
// X0Y0D03*
// %ADD11MOIRE2*%
// D11*
// X6000D03*
// M02*
// `

// moire with layerd object
// gerber = `
// %FSLAX34Y34*%
// %MOIN*%
// %AMMOIRE1*
// 6,0,0,0.5,0.04,0.03,2,0.01,0.55,0*%
// %AMMOIRE2*
// 6,0,0,0.5,0.04,0.03,4,0.01,0.55,0*%
// %ADD10MOIRE1*%
// %AMTEST*
// 0 dark 1"x0.5" center rect at 0,0*
// 21,1,1,0.5,0,0,0*
// 0 clear 0.4" circle at 0,0*
// 1,0,0.4,0,0*
// 0 dark 0.1"x0.75" center rect at 0,0*
// 21,1,0.1,0.75,0,0,0*
// 0 dark 0.75"x0.1" center rect at 0,0.35*
// 21,1,0.75,0.1,0,0.35,0*
// 0 clear 0.1" circle at 0,0.35"*
// 1,0,0.1,0,0.35*
// 0 clear 0.1" circle at -0.35,0"*
// 1,0,0.1,-0.35,0*
// 0 clear 0.1" circle at 0.35,0"*
// 1,0,0.1,0.35,0*%
// %ADD19TEST*%
// D10*
// X0Y0D03*
// %ADD11MOIRE2*%
// D11*
// X6000D03*
// D19*
// X0Y0D03*
// M02*
// `
// // TODO: IMPLEMENT STEP AND REPEAT
// gerber = `%FSLAX34Y34*%
// %MOIN*%
// %ADD10R,0.5X0.5*%
// %SRX3Y2I1J1*%
// D10*
// X0Y0D03*
// M02*
// `

// gerber = `
// %FSLAX34Y34*%
// %MOIN*%
// %ADD10C,0.5*%
// D10*
// X0Y0D03*
// M02*
// `

// step and repeat multi pol
// gerber = `
// %FSLAX34Y34*%
// %MOIN*%
// %ADD10C,1*%
// %ADD11C,0.8*%
// %ADD12C,0.6*%
// %ADD13C,0.4*%
// %ADD14C,0.2*%
// %SRX2Y2I0.5J0.5*%
// D10*
// D03*
// %LPC*%
// D11*
// D03*
// %LPD*%
// D12*
// D03*
// %LPC*%
// D13*
// D03*
// %LPD*%
// D14*
// D03*
// M02*
// `

// testing
gerber = `*
%FSLAX24Y24*%
%MOIN*%
G04 A1 - rect50x100xr10 *
%AMA1features*
22,1,0.030000,0.100000,-0.015000,-0.050000,0.0*
1,1,0.020000,-0.015000,-0.040000*
1,1,0.020000,-0.015000,0.040000*
20,1,0.020000,-0.015000,-0.040000,-0.015000,0.040000,0.0*
1,1,0.020000,0.015000,-0.040000*
1,1,0.020000,0.015000,0.040000*
20,1,0.020000,0.015000,-0.040000,0.015000,0.040000,0.0*
%
G04 A2 - rect50x100xr10x234 *
%AMA2features*
22,1,0.030000,0.100000,-0.015000,-0.050000,0.0*
1,1,0.020000,-0.015000,-0.040000*
1,1,0.020000,-0.015000,0.040000*
20,1,0.020000,-0.015000,-0.040000,-0.015000,0.040000,0.0*
1,1,0.020000,0.015000,-0.040000*
1,1,0.020000,0.015000,0.040000*
20,1,0.020000,0.015000,-0.040000,0.015000,0.040000,0.0*
21,1,0.020000,0.020000,0.015000,0.040000,0.0*
%
G04 A3 - rect50x100xr10x24 *
%AMA3features*
22,1,0.030000,0.100000,-0.015000,-0.050000,0.0*
1,1,0.020000,-0.015000,-0.040000*
1,1,0.020000,-0.015000,0.040000*
20,1,0.020000,-0.015000,-0.040000,-0.015000,0.040000,0.0*
1,1,0.020000,0.015000,-0.040000*
1,1,0.020000,0.015000,0.040000*
20,1,0.020000,0.015000,-0.040000,0.015000,0.040000,0.0*
21,1,0.020000,0.020000,0.015000,0.040000,0.0*
21,1,0.020000,0.020000,-0.015000,-0.040000,0.0*
%
G04 A4 - rect50x100xc10 *
%AMA4features*
4,1,8,0.025000,0.040000,0.025000,-0.040000,0.015000,-0.050000,-0.015000,-0.050000,-0.025000,-0.040000,-0.025000,0.040000,-0.015000,0.050000,0.015000,0.050000,0.025000,0.040000,0.000000*
%
G04 A5 - rect50x100xc10x24 *
%AMA5features*
4,1,6,0.025000,0.050000,0.025000,-0.040000,0.015000,-0.050000,-0.025000,-0.050000,-0.025000,0.040000,-0.015000,0.050000,0.025000,0.050000,0.000000*
%
G04 A6 - di100x100 *
%AMA6features*
21,1,0.070711,0.070711,0.000000,0.000000,45.000000*
%
G04 A7 - oct100x100x10 *
%AMA7features*
4,1,8,-0.040000,-0.050000,-0.050000,-0.040000,-0.050000,0.040000,-0.040000,0.050000,0.040000,0.050000,0.050000,0.040000,0.050000,-0.040000,0.040000,-0.050000,-0.040000,-0.050000,0.000000*
%
G04 A8 - oct100x100x25 *
%AMA8features*
4,1,8,-0.025000,-0.050000,-0.050000,-0.025000,-0.050000,0.025000,-0.025000,0.050000,0.025000,0.050000,0.050000,0.025000,0.050000,-0.025000,0.025000,-0.050000,-0.025000,-0.050000,0.000000*
%
G04 A9 - hex_l100x100x20 *
%AMA9features*
4,1,6,-0.030000,-0.050000,-0.050000,0.000000,-0.030000,0.050000,0.030000,0.050000,0.050000,0.000000,0.030000,-0.050000,-0.030000,-0.050000,0.000000*
%
G04 A10 - hex_s100x100x10 *
%AMA10features*
4,1,6,0.000000,-0.050000,-0.050000,-0.040000,-0.050000,0.040000,0.000000,0.050000,0.050000,0.040000,0.050000,-0.040000,0.000000,-0.050000,0.000000*
%
G04 A11 - bfr100 *
%AMA11features*
1,1,0.001000,-0.049497,0.000500*
1,1,0.001000,-0.048474,0.010024*
20,1,0.001000,-0.049497,0.000500,-0.048474,0.010024,0.0*
1,1,0.001000,-0.048474,0.010024*
1,1,0.001000,-0.045636,0.019174*
20,1,0.001000,-0.048474,0.010024,-0.045636,0.019174,0.0*
1,1,0.001000,-0.045636,0.019174*
1,1,0.001000,-0.041088,0.027605*
20,1,0.001000,-0.045636,0.019174,-0.041088,0.027605,0.0*
1,1,0.001000,-0.041088,0.027605*
1,1,0.001000,-0.035002,0.035002*
20,1,0.001000,-0.041088,0.027605,-0.035002,0.035002,0.0*
1,1,0.001000,-0.035002,0.035002*
1,1,0.001000,-0.027605,0.041088*
20,1,0.001000,-0.035002,0.035002,-0.027605,0.041088,0.0*
1,1,0.001000,-0.027605,0.041088*
1,1,0.001000,-0.019174,0.045636*
20,1,0.001000,-0.027605,0.041088,-0.019174,0.045636,0.0*
1,1,0.001000,-0.019174,0.045636*
1,1,0.001000,-0.010024,0.048474*
20,1,0.001000,-0.019174,0.045636,-0.010024,0.048474,0.0*
1,1,0.001000,-0.010024,0.048474*
1,1,0.001000,-0.000500,0.049497*
20,1,0.001000,-0.010024,0.048474,-0.000500,0.049497,0.0*
1,1,0.001000,-0.000500,0.049497*
1,1,0.001000,-0.000500,0.000500*
20,1,0.001000,-0.000500,0.049497,-0.000500,0.000500,0.0*
1,1,0.001000,-0.000500,0.000500*
1,1,0.001000,-0.049497,0.000500*
20,1,0.001000,-0.000500,0.000500,-0.049497,0.000500,0.0*
1,1,0.001000,0.000500,-0.049497*
1,1,0.001000,0.000500,-0.000500*
20,1,0.001000,0.000500,-0.049497,0.000500,-0.000500,0.0*
1,1,0.001000,0.000500,-0.000500*
1,1,0.001000,0.049497,-0.000500*
20,1,0.001000,0.000500,-0.000500,0.049497,-0.000500,0.0*
1,1,0.001000,0.049497,-0.000500*
1,1,0.001000,0.048474,-0.010024*
20,1,0.001000,0.049497,-0.000500,0.048474,-0.010024,0.0*
1,1,0.001000,0.048474,-0.010024*
1,1,0.001000,0.045636,-0.019174*
20,1,0.001000,0.048474,-0.010024,0.045636,-0.019174,0.0*
1,1,0.001000,0.045636,-0.019174*
1,1,0.001000,0.041088,-0.027605*
20,1,0.001000,0.045636,-0.019174,0.041088,-0.027605,0.0*
1,1,0.001000,0.041088,-0.027605*
1,1,0.001000,0.035002,-0.035002*
20,1,0.001000,0.041088,-0.027605,0.035002,-0.035002,0.0*
1,1,0.001000,0.035002,-0.035002*
1,1,0.001000,0.027605,-0.041088*
20,1,0.001000,0.035002,-0.035002,0.027605,-0.041088,0.0*
1,1,0.001000,0.027605,-0.041088*
1,1,0.001000,0.019174,-0.045636*
20,1,0.001000,0.027605,-0.041088,0.019174,-0.045636,0.0*
1,1,0.001000,0.019174,-0.045636*
1,1,0.001000,0.010024,-0.048474*
20,1,0.001000,0.019174,-0.045636,0.010024,-0.048474,0.0*
1,1,0.001000,0.010024,-0.048474*
1,1,0.001000,0.000500,-0.049497*
20,1,0.001000,0.010024,-0.048474,0.000500,-0.049497,0.0*
1,1,0.016000,-0.041231,0.008000*
1,1,0.016000,-0.008000,0.008000*
20,1,0.016000,-0.041231,0.008000,-0.008000,0.008000,0.0*
1,1,0.016000,-0.037286,0.019333*
1,1,0.016000,-0.008000,0.019333*
20,1,0.016000,-0.037286,0.019333,-0.008000,0.019333,0.0*
1,1,0.016000,-0.028698,0.030667*
1,1,0.016000,-0.008000,0.030667*
20,1,0.016000,-0.028698,0.030667,-0.008000,0.030667,0.0*
1,1,0.002000,-0.048990,0.001000*
1,1,0.002000,-0.047906,0.010294*
20,1,0.002000,-0.048990,0.001000,-0.047906,0.010294,0.0*
1,1,0.002000,-0.047906,0.010294*
1,1,0.002000,-0.045076,0.019212*
20,1,0.002000,-0.047906,0.010294,-0.045076,0.019212,0.0*
1,1,0.002000,-0.045076,0.019212*
1,1,0.002000,-0.040602,0.027430*
20,1,0.002000,-0.045076,0.019212,-0.040602,0.027430,0.0*
1,1,0.002000,-0.040602,0.027430*
1,1,0.002000,-0.034648,0.034648*
20,1,0.002000,-0.040602,0.027430,-0.034648,0.034648,0.0*
1,1,0.002000,-0.034648,0.034648*
1,1,0.002000,-0.027430,0.040602*
20,1,0.002000,-0.034648,0.034648,-0.027430,0.040602,0.0*
1,1,0.002000,-0.027430,0.040602*
1,1,0.002000,-0.019212,0.045076*
20,1,0.002000,-0.027430,0.040602,-0.019212,0.045076,0.0*
1,1,0.002000,-0.019212,0.045076*
1,1,0.002000,-0.010294,0.047906*
20,1,0.002000,-0.019212,0.045076,-0.010294,0.047906,0.0*
1,1,0.002000,-0.010294,0.047906*
1,1,0.002000,-0.001000,0.048990*
20,1,0.002000,-0.010294,0.047906,-0.001000,0.048990,0.0*
1,1,0.002000,-0.001000,0.048990*
1,1,0.002000,-0.001000,0.001000*
20,1,0.002000,-0.001000,0.048990,-0.001000,0.001000,0.0*
1,1,0.016000,-0.041231,0.008000*
1,1,0.016000,-0.038853,0.015951*
20,1,0.016000,-0.041231,0.008000,-0.038853,0.015951,0.0*
1,1,0.016000,-0.038853,0.015951*
1,1,0.016000,-0.034958,0.023279*
20,1,0.016000,-0.038853,0.015951,-0.034958,0.023279,0.0*
1,1,0.016000,-0.034958,0.023279*
1,1,0.016000,-0.029698,0.029698*
20,1,0.016000,-0.034958,0.023279,-0.029698,0.029698,0.0*
1,1,0.016000,-0.029698,0.029698*
1,1,0.016000,-0.023279,0.034958*
20,1,0.016000,-0.029698,0.029698,-0.023279,0.034958,0.0*
1,1,0.016000,-0.023279,0.034958*
1,1,0.016000,-0.015951,0.038853*
20,1,0.016000,-0.023279,0.034958,-0.015951,0.038853,0.0*
1,1,0.016000,-0.015951,0.038853*
1,1,0.016000,-0.008000,0.041231*
20,1,0.016000,-0.015951,0.038853,-0.008000,0.041231,0.0*
1,1,0.016000,-0.008000,0.041231*
1,1,0.016000,-0.008000,0.008000*
20,1,0.016000,-0.008000,0.041231,-0.008000,0.008000,0.0*
1,1,0.002000,-0.001000,0.001000*
1,1,0.002000,-0.048990,0.001000*
20,1,0.002000,-0.001000,0.001000,-0.048990,0.001000,0.0*
1,1,0.004000,-0.047958,0.002000*
1,1,0.004000,-0.046762,0.010831*
20,1,0.004000,-0.047958,0.002000,-0.046762,0.010831,0.0*
1,1,0.004000,-0.046762,0.010831*
1,1,0.004000,-0.043954,0.019289*
20,1,0.004000,-0.046762,0.010831,-0.043954,0.019289,0.0*
1,1,0.004000,-0.043954,0.019289*
1,1,0.004000,-0.039630,0.027082*
20,1,0.004000,-0.043954,0.019289,-0.039630,0.027082,0.0*
1,1,0.004000,-0.039630,0.027082*
1,1,0.004000,-0.033941,0.033941*
20,1,0.004000,-0.039630,0.027082,-0.033941,0.033941,0.0*
1,1,0.004000,-0.033941,0.033941*
1,1,0.004000,-0.027082,0.039630*
20,1,0.004000,-0.033941,0.033941,-0.027082,0.039630,0.0*
1,1,0.004000,-0.027082,0.039630*
1,1,0.004000,-0.019289,0.043954*
20,1,0.004000,-0.027082,0.039630,-0.019289,0.043954,0.0*
1,1,0.004000,-0.019289,0.043954*
1,1,0.004000,-0.010831,0.046762*
20,1,0.004000,-0.019289,0.043954,-0.010831,0.046762,0.0*
1,1,0.004000,-0.010831,0.046762*
1,1,0.004000,-0.002000,0.047958*
20,1,0.004000,-0.010831,0.046762,-0.002000,0.047958,0.0*
1,1,0.004000,-0.002000,0.002000*
1,1,0.004000,-0.047958,0.002000*
20,1,0.004000,-0.002000,0.002000,-0.047958,0.002000,0.0*
1,1,0.008000,-0.045826,0.004000*
1,1,0.008000,-0.044124,0.013003*
20,1,0.008000,-0.045826,0.004000,-0.044124,0.013003,0.0*
1,1,0.008000,-0.044124,0.013003*
1,1,0.008000,-0.040671,0.021491*
20,1,0.008000,-0.044124,0.013003,-0.040671,0.021491,0.0*
1,1,0.008000,-0.040671,0.021491*
1,1,0.008000,-0.035605,0.029126*
20,1,0.008000,-0.040671,0.021491,-0.035605,0.029126,0.0*
1,1,0.008000,-0.035605,0.029126*
1,1,0.008000,-0.029126,0.035605*
20,1,0.008000,-0.035605,0.029126,-0.029126,0.035605,0.0*
1,1,0.008000,-0.029126,0.035605*
1,1,0.008000,-0.021491,0.040671*
20,1,0.008000,-0.029126,0.035605,-0.021491,0.040671,0.0*
1,1,0.008000,-0.021491,0.040671*
1,1,0.008000,-0.013003,0.044124*
20,1,0.008000,-0.021491,0.040671,-0.013003,0.044124,0.0*
1,1,0.008000,-0.013003,0.044124*
1,1,0.008000,-0.004000,0.045826*
20,1,0.008000,-0.013003,0.044124,-0.004000,0.045826,0.0*
1,1,0.008000,-0.004000,0.004000*
1,1,0.008000,-0.045826,0.004000*
20,1,0.008000,-0.004000,0.004000,-0.045826,0.004000,0.0*
1,1,0.004000,-0.002000,0.047958*
1,1,0.004000,-0.002000,0.002000*
20,1,0.004000,-0.002000,0.047958,-0.002000,0.002000,0.0*
1,1,0.008000,-0.004000,0.045826*
1,1,0.008000,-0.004000,0.004000*
20,1,0.008000,-0.004000,0.045826,-0.004000,0.004000,0.0*
1,1,0.016000,0.008000,-0.030667*
1,1,0.016000,0.028698,-0.030667*
20,1,0.016000,0.008000,-0.030667,0.028698,-0.030667,0.0*
1,1,0.016000,0.008000,-0.019333*
1,1,0.016000,0.037286,-0.019333*
20,1,0.016000,0.008000,-0.019333,0.037286,-0.019333,0.0*
1,1,0.016000,0.008000,-0.008000*
1,1,0.016000,0.041231,-0.008000*
20,1,0.016000,0.008000,-0.008000,0.041231,-0.008000,0.0*
1,1,0.002000,0.001000,-0.048990*
1,1,0.002000,0.001000,-0.001000*
20,1,0.002000,0.001000,-0.048990,0.001000,-0.001000,0.0*
1,1,0.002000,0.048990,-0.001000*
1,1,0.002000,0.047906,-0.010294*
20,1,0.002000,0.048990,-0.001000,0.047906,-0.010294,0.0*
1,1,0.002000,0.047906,-0.010294*
1,1,0.002000,0.045076,-0.019212*
20,1,0.002000,0.047906,-0.010294,0.045076,-0.019212,0.0*
1,1,0.002000,0.045076,-0.019212*
1,1,0.002000,0.040602,-0.027430*
20,1,0.002000,0.045076,-0.019212,0.040602,-0.027430,0.0*
1,1,0.002000,0.040602,-0.027430*
1,1,0.002000,0.034648,-0.034648*
20,1,0.002000,0.040602,-0.027430,0.034648,-0.034648,0.0*
1,1,0.002000,0.034648,-0.034648*
1,1,0.002000,0.027430,-0.040602*
20,1,0.002000,0.034648,-0.034648,0.027430,-0.040602,0.0*
1,1,0.002000,0.027430,-0.040602*
1,1,0.002000,0.019212,-0.045076*
20,1,0.002000,0.027430,-0.040602,0.019212,-0.045076,0.0*
1,1,0.002000,0.019212,-0.045076*
1,1,0.002000,0.010294,-0.047906*
20,1,0.002000,0.019212,-0.045076,0.010294,-0.047906,0.0*
1,1,0.002000,0.010294,-0.047906*
1,1,0.002000,0.001000,-0.048990*
20,1,0.002000,0.010294,-0.047906,0.001000,-0.048990,0.0*
1,1,0.016000,0.008000,-0.041231*
1,1,0.016000,0.008000,-0.008000*
20,1,0.016000,0.008000,-0.041231,0.008000,-0.008000,0.0*
1,1,0.016000,0.041231,-0.008000*
1,1,0.016000,0.038853,-0.015951*
20,1,0.016000,0.041231,-0.008000,0.038853,-0.015951,0.0*
1,1,0.016000,0.038853,-0.015951*
1,1,0.016000,0.034958,-0.023279*
20,1,0.016000,0.038853,-0.015951,0.034958,-0.023279,0.0*
1,1,0.016000,0.034958,-0.023279*
1,1,0.016000,0.029698,-0.029698*
20,1,0.016000,0.034958,-0.023279,0.029698,-0.029698,0.0*
1,1,0.016000,0.029698,-0.029698*
1,1,0.016000,0.023279,-0.034958*
20,1,0.016000,0.029698,-0.029698,0.023279,-0.034958,0.0*
1,1,0.016000,0.023279,-0.034958*
1,1,0.016000,0.015951,-0.038853*
20,1,0.016000,0.023279,-0.034958,0.015951,-0.038853,0.0*
1,1,0.016000,0.015951,-0.038853*
1,1,0.016000,0.008000,-0.041231*
20,1,0.016000,0.015951,-0.038853,0.008000,-0.041231,0.0*
1,1,0.002000,0.001000,-0.001000*
1,1,0.002000,0.048990,-0.001000*
20,1,0.002000,0.001000,-0.001000,0.048990,-0.001000,0.0*
1,1,0.004000,0.002000,-0.047958*
1,1,0.004000,0.002000,-0.002000*
20,1,0.004000,0.002000,-0.047958,0.002000,-0.002000,0.0*
1,1,0.004000,0.047958,-0.002000*
1,1,0.004000,0.046762,-0.010831*
20,1,0.004000,0.047958,-0.002000,0.046762,-0.010831,0.0*
1,1,0.004000,0.046762,-0.010831*
1,1,0.004000,0.043954,-0.019289*
20,1,0.004000,0.046762,-0.010831,0.043954,-0.019289,0.0*
1,1,0.004000,0.043954,-0.019289*
1,1,0.004000,0.039630,-0.027082*
20,1,0.004000,0.043954,-0.019289,0.039630,-0.027082,0.0*
1,1,0.004000,0.039630,-0.027082*
1,1,0.004000,0.033941,-0.033941*
20,1,0.004000,0.039630,-0.027082,0.033941,-0.033941,0.0*
1,1,0.004000,0.033941,-0.033941*
1,1,0.004000,0.027082,-0.039630*
20,1,0.004000,0.033941,-0.033941,0.027082,-0.039630,0.0*
1,1,0.004000,0.027082,-0.039630*
1,1,0.004000,0.019289,-0.043954*
20,1,0.004000,0.027082,-0.039630,0.019289,-0.043954,0.0*
1,1,0.004000,0.019289,-0.043954*
1,1,0.004000,0.010831,-0.046762*
20,1,0.004000,0.019289,-0.043954,0.010831,-0.046762,0.0*
1,1,0.004000,0.010831,-0.046762*
1,1,0.004000,0.002000,-0.047958*
20,1,0.004000,0.010831,-0.046762,0.002000,-0.047958,0.0*
1,1,0.008000,0.004000,-0.045826*
1,1,0.008000,0.004000,-0.004000*
20,1,0.008000,0.004000,-0.045826,0.004000,-0.004000,0.0*
1,1,0.008000,0.045826,-0.004000*
1,1,0.008000,0.044124,-0.013003*
20,1,0.008000,0.045826,-0.004000,0.044124,-0.013003,0.0*
1,1,0.008000,0.044124,-0.013003*
1,1,0.008000,0.040671,-0.021491*
20,1,0.008000,0.044124,-0.013003,0.040671,-0.021491,0.0*
1,1,0.008000,0.040671,-0.021491*
1,1,0.008000,0.035605,-0.029126*
20,1,0.008000,0.040671,-0.021491,0.035605,-0.029126,0.0*
1,1,0.008000,0.035605,-0.029126*
1,1,0.008000,0.029126,-0.035605*
20,1,0.008000,0.035605,-0.029126,0.029126,-0.035605,0.0*
1,1,0.008000,0.029126,-0.035605*
1,1,0.008000,0.021491,-0.040671*
20,1,0.008000,0.029126,-0.035605,0.021491,-0.040671,0.0*
1,1,0.008000,0.021491,-0.040671*
1,1,0.008000,0.013003,-0.044124*
20,1,0.008000,0.021491,-0.040671,0.013003,-0.044124,0.0*
1,1,0.008000,0.013003,-0.044124*
1,1,0.008000,0.004000,-0.045826*
20,1,0.008000,0.013003,-0.044124,0.004000,-0.045826,0.0*
1,1,0.004000,0.002000,-0.002000*
1,1,0.004000,0.047958,-0.002000*
20,1,0.004000,0.002000,-0.002000,0.047958,-0.002000,0.0*
1,1,0.008000,0.004000,-0.004000*
1,1,0.008000,0.045826,-0.004000*
20,1,0.008000,0.004000,-0.004000,0.045826,-0.004000,0.0*
%
G04 A12 - bfs100 *
%AMA12features*
21,1,0.050000,0.050000,-0.025000,0.025000,0.0*
21,1,0.050000,0.050000,0.025000,-0.025000,0.0*
%
G04 A13 - tri100x100 *
%AMA13features*
4,1,3,-0.050000,-0.050000,0.000000,0.050000,0.050000,-0.050000,-0.050000,-0.050000,0.000000*
%
G04 A14 - oval_h100x100 *
%AMA14features*
1,1,0.100000,0.000000,0.000000*
22,1,0.050000,0.100000,-0.050000,-0.050000,0.0*
%
G04 A15 - thr100x50x0x4x10 *
%AMA15features*
1,1,0.025000,0.033166,0.017500*
1,1,0.025000,0.028399,0.024679*
20,1,0.025000,0.033166,0.017500,0.028399,0.024679,0.0*
1,1,0.025000,0.028399,0.024679*
1,1,0.025000,0.022027,0.030502*
20,1,0.025000,0.028399,0.024679,0.022027,0.030502,0.0*
1,1,0.025000,0.022027,0.030502*
1,1,0.025000,0.017500,0.033166*
20,1,0.025000,0.022027,0.030502,0.017500,0.033166,0.0*
1,1,0.025000,-0.017500,0.033166*
1,1,0.025000,-0.024679,0.028399*
20,1,0.025000,-0.017500,0.033166,-0.024679,0.028399,0.0*
1,1,0.025000,-0.024679,0.028399*
1,1,0.025000,-0.030502,0.022027*
20,1,0.025000,-0.024679,0.028399,-0.030502,0.022027,0.0*
1,1,0.025000,-0.030502,0.022027*
1,1,0.025000,-0.033166,0.017500*
20,1,0.025000,-0.030502,0.022027,-0.033166,0.017500,0.0*
1,1,0.025000,-0.033166,-0.017500*
1,1,0.025000,-0.028399,-0.024679*
20,1,0.025000,-0.033166,-0.017500,-0.028399,-0.024679,0.0*
1,1,0.025000,-0.028399,-0.024679*
1,1,0.025000,-0.022027,-0.030502*
20,1,0.025000,-0.028399,-0.024679,-0.022027,-0.030502,0.0*
1,1,0.025000,-0.022027,-0.030502*
1,1,0.025000,-0.017500,-0.033166*
20,1,0.025000,-0.022027,-0.030502,-0.017500,-0.033166,0.0*
1,1,0.025000,0.017500,-0.033166*
1,1,0.025000,0.024679,-0.028399*
20,1,0.025000,0.017500,-0.033166,0.024679,-0.028399,0.0*
1,1,0.025000,0.024679,-0.028399*
1,1,0.025000,0.030502,-0.022027*
20,1,0.025000,0.024679,-0.028399,0.030502,-0.022027,0.0*
1,1,0.025000,0.030502,-0.022027*
1,1,0.025000,0.033166,-0.017500*
20,1,0.025000,0.030502,-0.022027,0.033166,-0.017500,0.0*
%
G04 A16 - ths100x50x0x4x10 *
%AMA16features*
7,0.000000,0.000000,0.100000,0.050000,0.010000,0.000000*
%
G04 A17 - ths100x50x0x10x10 *
%AMA17features*
1,1,0.100000,0.000000,0.000000*
1,0,0.050000,0.000000,0.000000*
22,0,0.131421,0.010000,0.015000,-0.005000,0.0*
20,0,0.010000,0.012135,0.008817,0.118457,0.086064,0.0*
20,0,0.010000,0.004635,0.014266,0.045247,0.139255,0.0*
20,0,0.010000,-0.004635,0.014266,-0.045247,0.139255,0.0*
20,0,0.010000,-0.012135,0.008817,-0.118457,0.086064,0.0*
22,0,0.131421,0.010000,-0.146421,-0.005000,0.0*
20,0,0.010000,-0.012135,-0.008817,-0.118457,-0.086064,0.0*
20,0,0.010000,-0.004635,-0.014266,-0.045247,-0.139255,0.0*
20,0,0.010000,0.004635,-0.014266,0.045247,-0.139255,0.0*
20,0,0.010000,0.012135,-0.008817,0.118457,-0.086064,0.0*
%
G04 A18 - thr100x50x0x5x10 *
%AMA18features*
1,1,0.025000,0.033166,0.017500*
1,1,0.025000,0.028399,0.024679*
20,1,0.025000,0.033166,0.017500,0.028399,0.024679,0.0*
1,1,0.025000,0.028399,0.024679*
1,1,0.025000,0.026892,0.026135*
20,1,0.025000,0.028399,0.024679,0.026892,0.026135,0.0*
1,1,0.025000,-0.006395,0.036951*
1,1,0.025000,-0.014696,0.034635*
20,1,0.025000,-0.006395,0.036951,-0.014696,0.034635,0.0*
1,1,0.025000,-0.014696,0.034635*
1,1,0.025000,-0.016546,0.033652*
20,1,0.025000,-0.014696,0.034635,-0.016546,0.033652,0.0*
1,1,0.025000,-0.037118,0.005337*
1,1,0.025000,-0.037481,-0.003274*
20,1,0.025000,-0.037118,0.005337,-0.037481,-0.003274,0.0*
1,1,0.025000,-0.037481,-0.003274*
1,1,0.025000,-0.037118,-0.005337*
20,1,0.025000,-0.037481,-0.003274,-0.037118,-0.005337,0.0*
1,1,0.025000,-0.016546,-0.033652*
1,1,0.025000,-0.008469,-0.036658*
20,1,0.025000,-0.016546,-0.033652,-0.008469,-0.036658,0.0*
1,1,0.025000,-0.008469,-0.036658*
1,1,0.025000,-0.006395,-0.036951*
20,1,0.025000,-0.008469,-0.036658,-0.006395,-0.036951,0.0*
1,1,0.025000,0.026892,-0.026135*
1,1,0.025000,0.032247,-0.019382*
20,1,0.025000,0.026892,-0.026135,0.032247,-0.019382,0.0*
1,1,0.025000,0.032247,-0.019382*
1,1,0.025000,0.033166,-0.017500*
20,1,0.025000,0.032247,-0.019382,0.033166,-0.017500,0.0*
%
G04 A19 - s_ths100x50x0x4x10 *
%AMA19features*
21,1,0.100000,0.100000,0.000000,0.000000,0.000000*
21,0,0.050000,0.050000,0.000000,0.000000,0.000000*
21,0,0.100000,0.010000,0.000000,0.000000,0.000000*
21,0,0.010000,0.100000,0.000000,0.000000,0.000000*
%
G04 A20 - s_ths100x50x0x10x10 *
%AMA20features*
21,1,0.100000,0.100000,0.000000,0.000000,0.0*
21,0,0.050000,0.050000,0.000000,0.000000,0.0*
22,0,0.131421,0.010000,0.015000,-0.005000,0.0*
20,0,0.010000,0.012135,0.008817,0.118457,0.086064,0.0*
20,0,0.010000,0.004635,0.014266,0.045247,0.139255,0.0*
20,0,0.010000,-0.004635,0.014266,-0.045247,0.139255,0.0*
20,0,0.010000,-0.012135,0.008817,-0.118457,0.086064,0.0*
22,0,0.131421,0.010000,-0.146421,-0.005000,0.0*
20,0,0.010000,-0.012135,-0.008817,-0.118457,-0.086064,0.0*
20,0,0.010000,-0.004635,-0.014266,-0.045247,-0.139255,0.0*
20,0,0.010000,0.004635,-0.014266,0.045247,-0.139255,0.0*
20,0,0.010000,0.012135,-0.008817,0.118457,-0.086064,0.0*
%
G04 A21 - sr_ths100x50x0x4x10 *
%AMA21features*
21,1,0.100000,0.100000,0.000000,0.000000,0.000000*
1,0,0.050000,0.000000,0.000000*
21,0,0.100000,0.010000,0.000000,0.000000,0.000000*
21,0,0.010000,0.100000,0.000000,0.000000,0.000000*
%
G04 A22 - moire10x10x2x1x100x50 *
%AMA22features*
6,0.000000,0.000000,0.080000,0.010000,0.005000,2,0.001000,0.101000,50.000000*
%
%ADD10C,0.100000*%
%ADD11R,0.100000X0.100000*%
%ADD12R,0.030000X0.100000*%
%ADD13A1features*%
%ADD14A2features*%
%ADD15A3features*%
%ADD16A4features*%
%ADD17A5features*%
%ADD18O,0.040000X0.100000*%
%ADD19A6features*%
%ADD20A7features*%
%ADD21A8features*%
%ADD22C,0.100000X0.050000*%
%ADD23R,0.100000X0.100000X0.050000X0.050000*%
%ADD24A9features*%
%ADD25A10features*%
%ADD26A11features*%
%ADD27A12features*%
%ADD28A13features*%
%ADD29A14features*%
%ADD30A15features*%
%ADD31A16features*%
%ADD32A17features*%
%ADD33A18features*%
%ADD34A19features*%
%ADD35A20features*%
%ADD36A21features*%
%ADD37A22features*%
%ADD38R,0.064000X0.064000*%
%ADD39C,0.010000*%
%ADD40R,0.016000X0.016000*%
%ADD41C,0.012000*%
%IPPOS*%
%LNfeaturesfeatures.gbr*%
%LPD*%
G75*
G54D10*
X000000Y000807D03*
G54D11*
X001170Y000798D03*
G54D12*
X002029Y000793D03*
G54D13*
X002528Y000792D03*
G54D14*
X003113Y000796D03*
G54D15*
X003754Y000789D03*
G54D16*
X004397Y000791D03*
G54D17*
X005044Y000792D03*
G54D18*
X005627Y000807D03*
G54D19*
X006443Y000797D03*
G54D20*
X007561Y000800D03*
G54D21*
X008783Y000805D03*
G54D22*
X009975Y000780D03*
G54D23*
X011177Y000785D03*
G54D24*
X012486Y000785D03*
G54D25*
X013717Y000785D03*
G54D26*
X014876Y000780D03*
G54D27*
X016101Y000855D03*
G54D28*
X017352Y000891D03*
G54D29*
X018729Y000875D03*
G54D30*
X020016Y000903D03*
G54D31*
X021176Y000901D03*
G54D32*
X022355Y000894D03*
G54D33*
X023495Y000928D03*
G54D34*
X024725Y000954D03*
G54D35*
X025926Y000932D03*
G54D36*
X027060Y000928D03*
G54D37*
X028214Y000966D03*
G54D10*
X-000028Y002060D03*
%LPC*%
G75*
X-000028Y002060D02*
G54D10*
X000305D03*
%LPD*%
G75*
X000305Y002060D02*
G54D10*
X000754D03*
%LPC*%
G75*
X000754Y002060D02*
G54D10*
X001174Y002031D03*
%LPD*%
G75*
X001174Y002031D02*
G54D10*
X001653Y002104D03*
G54D38*
X003523Y002047D02*
X006361D01*
X003523Y002233D02*
X006361D01*
%LPC*%
G75*
X006361Y002233D02*
G54D10*
X003841Y002162D03*
%LPD*%
G75*
X003841Y002162D02*
G54D10*
X004333Y002147D03*
%LPC*%
G75*
X004333Y002147D02*
G54D39*
X004102Y001886D02*
X004696Y002379D01*
%LPD*%
G75*
X004696Y002379D02*
G54D39*
X004174Y002423D02*
X004565Y001930D01*
%LPC*%
G75*
X004565Y001930D02*
G54D40*
X005225Y002111D02*
X006137D01*
X005225Y002191D02*
X006137D01*
X005225Y002270D02*
X006137D01*
%LPD*%
G75*
X006137Y002270D02*
G54D39*
X005232Y002176D02*
X006087D01*
G54D41*
X007379Y002618D02*
X007961D01*
X007670D02*
Y001743D01*
X008379Y002618D02*
X008961D01*
X008379Y001743D02*
X008961D01*
X008379Y002181D02*
X008816D01*
X008379Y002618D02*
Y001743D01*
X009379Y001889D02*
X009524Y001743D01*
X009816D01*
X009961Y001889D01*
Y002035D01*
X009816Y002181D01*
X009524D01*
X009379Y002326D01*
Y002472D01*
X009524Y002618D01*
X009816D01*
X009961Y002472D01*
X010379Y002618D02*
X010961D01*
X010670D02*
Y001743D01*
M02*
`

// gerber = `%FSLAX34Y34*%
// %MOIN*%
// %AMTHERMAL*
// 7,0,0,0.5,0.4,0.1,0*%
// %ADD10THERMAL*%
// %ADD11R,1.1X1.1*%
// %LPD*%
// D11*
// X0Y0D03*
// %LPC*%
// D10*
// X0Y0D03*
// M02*

// `


export default function Test() {
  const inputRef = useRef<HTMLDivElement>(document.createElement('div'))

  useEffect(() => {
    const pixi = insertPixiCanvas()
    return () => {
      pixi.destroy(true)
      inputRef.current.innerHTML = ''
    }
  }, [])

  async function parserGerber(gerber: string): Promise<ImageTree> {
    const syntaxTree = parse(gerber)
    console.log('Syntax Tree:', syntaxTree)
    const imagetree = plot(syntaxTree)
    console.log('Image Tree:', imagetree)
    return imagetree
  }

  function insertPixiCanvas() {
    const pixi = new CustomPixiApplication(inputRef, {
      width: inputRef.current.clientWidth,
      height: inputRef.current.clientHeight,
      antialias: false,
      autoDensity: true,
      backgroundColor: 0x0,
      resolution: devicePixelRatio,
    })

    const containerObserver = new ResizeObserver((entries) => {
      const { width, height } = entries[0].contentRect
      pixi.renderer.resize(width, height)
      pixi.viewport.resize(width, height)
    })
    containerObserver.observe(inputRef.current)

    inputRef.current.appendChild(pixi.view as HTMLCanvasElement)

    parserGerber(gerber).then((imageTree) => pixi.renderImageTree(imageTree))

    if (pixi.renderer.type == PIXI.RENDERER_TYPE.WEBGL) {
      console.log('Using WebGL')
    } else {
      console.log('Using Canvas')
    }

    return pixi
  }

  return <div id='GRX' style={{ width: '100%', height: '100%' }} ref={inputRef} />
}
